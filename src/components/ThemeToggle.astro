---
import ToggleThemeIcon from "@/assets/icons/toggle-theme.svg"
---

<button
  type="button"
  class="inline-flex cursor-pointer items-center justify-center p-1.5 rounded-lg text-primary hover:bg-primary/10 transition-colors"
  data-theme-toggle-btn
  aria-label="Switch to dark theme"
  title="Toggle theme"
>
  <ToggleThemeIcon width={18} height={18} aria-hidden="true" />
</button>

<script>
  type Theme = "light" | "dark"
  type ThemeApi = { toggle?: () => Theme }
  type Win = Window & { codeinkTheme?: ThemeApi; __codeinkThemeToggleInit?: boolean }
  const w = window as Win
  const storageKey = "codeink-theme"
  const selector = "[data-theme-toggle-btn]"

  if (!w.__codeinkThemeToggleInit) {
    w.__codeinkThemeToggleInit = true

    const getCurrentTheme = (): Theme =>
      document.documentElement.getAttribute("data-theme") === "light" ? "light" : "dark"

    const syncButtons = () => {
      const isDark = getCurrentTheme() === "dark"
      document.querySelectorAll(selector).forEach((el) => {
        const btn = el as HTMLButtonElement
        btn.setAttribute("aria-label", isDark ? "Switch to light theme" : "Switch to dark theme")
      })
    }

    const toggleTheme = () => {
      if (typeof w.codeinkTheme?.toggle === "function") {
        w.codeinkTheme.toggle()
        return
      }
      const nextTheme: Theme = getCurrentTheme() === "dark" ? "light" : "dark"
      document.documentElement.setAttribute("data-theme", nextTheme)
      try {
        localStorage.setItem(storageKey, nextTheme)
      } catch {}
      window.dispatchEvent(new CustomEvent("codeink-theme-change", { detail: { theme: nextTheme } }))
    }

    document.addEventListener("click", (event) => {
      const target = event.target as HTMLElement | null
      const button = target?.closest(selector) as HTMLButtonElement | null
      if (!button) return
      toggleTheme()
    })

    window.addEventListener("codeink-theme-change", syncButtons)
    document.addEventListener("astro:after-swap", syncButtons)
    document.addEventListener("astro:page-load", syncButtons)
    syncButtons()
  }
</script>
