---
import Header from "@/components/Header.astro"
import StatusBar from "@/components/StatusBar.astro"
import Logo from "@/assets/logo.svg"
---
<div id="editor-root" class="relative flex flex-col overflow-hidden editor-entrance bg-background">
  <div id="editor-loading" class="editor-loading">
    <Logo class="w-10 h-10 animate-pulse" aria-hidden="true" />
  </div>

  <Header showTabs>
    <a slot="left" href="/documents" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium text-muted-foreground hover:text-primary hover:bg-primary/10 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      <span class="sm:hidden">Docs</span><span class="hidden sm:inline">Documents</span>
    </a>
  </Header>

  <div class="flex flex-1 overflow-hidden">
    <div id="editor-pane" class="flex flex-col overflow-hidden min-w-0">
      <div class="pane-header">
        <div class="flex items-center gap-2">
          <span class="pane-dot bg-primary"></span>
          <span class="pane-label">EDITOR</span>
        </div>
        <span class="pane-meta" id="editor-meta">Markdown</span>
      </div>
      <div id="cm-editor" class="flex-1 min-h-0"></div>
    </div>

    <div id="resize-handle" class="resize-handle">
      <div class="resize-grip"></div>
    </div>

    <div id="preview-pane" class="flex flex-col overflow-hidden">
      <div class="preview-scroll-container">
        <div class="pane-header">
          <div class="flex items-center gap-2">
            <span class="pane-dot bg-[var(--success-accent)]"></span>
            <span class="pane-label">PREVIEW</span>
          </div>
          <span class="pane-meta" id="preview-meta">Live</span>
        </div>
        <div id="preview" class="markdown-prose flex-1 p-6 max-w-none min-w-fit"></div>
      </div>
    </div>
  </div>

  <StatusBar />
</div>

<style>
  /* Editor root height */
  #editor-root {
    height: calc(100vh / 1.1);
    height: calc(100dvh / 1.1);
  }

  @media (max-width: 639px), (max-height: 500px) {
    #editor-root {
      height: 100vh;
      height: 100dvh;
    }
  }

  /* Loading overlay */
  .editor-loading {
    position: absolute;
    inset: 0;
    z-index: 40;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--background);
  }

  #editor-root.loaded .editor-loading {
    display: none;
  }

  /* Pane headers */
  .preview-scroll-container > .pane-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    min-height: 32px;
    position: sticky;
    left: 0;
    width: 100%;
    min-width: fit-content;
  }

  .pane-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    min-height: 32px;
  }

  .pane-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .pane-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: var(--muted-foreground);
    font-family: var(--font-mono);
  }

  .pane-meta {
    font-size: 10px;
    color: var(--muted-foreground);
    opacity: 0.6;
    font-family: var(--font-mono);
  }

  /* Preview scroll container for horizontal scroll */
  .preview-scroll-container {
    display: flex;
    flex-direction: column;
    overflow: auto;
    flex: 1;
    min-height: 0;
  }

  /* Resize handle */
  .resize-handle {
    width: 5px;
    cursor: col-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--border);
    position: relative;
    transition: background 0.15s ease;
    flex-shrink: 0;
  }

  @media (max-width: 639px) {
    .resize-handle {
      display: none;
    }
  }

  .resize-handle:hover,
  .resize-handle.dragging {
    background: var(--primary);
  }

  .resize-grip {
    width: 3px;
    height: 24px;
    border-radius: 2px;
    opacity: 0;
    transition: opacity 0.15s ease;
  }

  .resize-handle:hover .resize-grip {
    opacity: 1;
    background: repeating-linear-gradient(
      0deg,
      var(--primary-foreground) 0px,
      var(--primary-foreground) 2px,
      transparent 2px,
      transparent 4px
    );
  }

  /* View modes */
  #editor-root[data-view="editor"] #editor-pane {
    flex: 1;
    min-width: 0;
  }
  #editor-root[data-view="editor"] #preview-pane,
  #editor-root[data-view="editor"] #resize-handle {
    display: none;
  }
  #editor-root[data-view="split"] #editor-pane {
    flex: 1;
    min-width: 0;
  }
  #editor-root[data-view="split"] #preview-pane {
    flex: 1;
    min-width: 0;
  }
  #editor-root[data-view="preview"] #editor-pane,
  #editor-root[data-view="preview"] #resize-handle {
    display: none;
  }
  #editor-root[data-view="preview"] #preview-pane {
    flex: 1;
    width: 100%;
  }
</style>

<script>
  import { initEditor } from "@/scripts/editor"

  function tryInit() {
    if (document.getElementById("editor-root")) {
      initEditor()
    }
  }

  document.addEventListener("astro:page-load", tryInit)
</script>
