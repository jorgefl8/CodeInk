---
import Header from "@/components/Header.astro"
---
<div id="editor-root" class="flex flex-col h-screen overflow-hidden editor-entrance">
  <Header>
    <a slot="left" href="/documents" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium text-muted-foreground hover:text-primary hover:bg-primary/10 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      Documents
    </a>
    <div slot="center" class="flex items-center rounded-lg bg-muted/30 p-0.5 gap-0.5">
      <button id="view-editor" type="button" class="view-btn" aria-label="Editor only">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
        Editor
      </button>
      <button id="view-split" type="button" class="view-btn" aria-label="Split view">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 3v18"/></svg>
        Split
      </button>
      <button id="view-preview" type="button" class="view-btn" aria-label="Preview only">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
        Preview
      </button>
    </div>
  </Header>

  <!-- Pane headers + content -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Editor pane -->
    <div id="editor-pane" class="flex flex-col overflow-hidden min-w-0">
      <div class="pane-header">
        <div class="flex items-center gap-2">
          <span class="pane-dot" style="background: var(--primary);"></span>
          <span class="pane-label">EDITOR</span>
        </div>
        <span class="pane-meta" id="editor-meta">Markdown</span>
      </div>
      <div id="cm-editor" class="flex-1 min-h-0"></div>
    </div>

    <!-- Resize handle -->
    <div id="resize-handle" class="resize-handle">
      <div class="resize-grip"></div>
    </div>

    <!-- Preview pane -->
    <div id="preview-pane" class="flex flex-col overflow-auto min-w-0">
      <div class="pane-header">
        <div class="flex items-center gap-2">
          <span class="pane-dot" style="background: #3fb950;"></span>
          <span class="pane-label">PREVIEW</span>
        </div>
        <span class="pane-meta" id="preview-meta">Live</span>
      </div>
      <div id="preview" class="markdown-prose flex-1 p-6 max-w-none"></div>
    </div>
  </div>

  <!-- Status bar -->
  <div id="status-bar" class="status-bar">
    <div class="flex items-center gap-4">
      <span class="status-item" id="status-lines">
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10H3"/><path d="M21 6H3"/><path d="M21 14H3"/><path d="M21 18H3"/></svg>
        0 lines
      </span>
      <span class="status-item" id="status-words">
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
        0 words
      </span>
      <span class="status-item" id="status-chars">
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>
        0 chars
      </span>
    </div>
    <div class="flex items-center gap-3">
      <span class="status-item" id="status-save">
        <svg class="save-icon save-icon--check" xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
        <svg class="save-icon save-icon--saving" xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        <span class="save-label">Saved locally</span>
      </span>
    </div>
  </div>
</div>

<style>
  /* View mode buttons */
  .view-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    border-radius: var(--radius);
    padding: 5px 10px;
    font-size: 11px;
    font-weight: 500;
    color: var(--muted-foreground);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s ease;
    border: none;
    background: transparent;
    position: relative;
  }

  .view-btn:hover {
    color: var(--foreground);
    background: rgba(255, 255, 255, 0.04);
  }

  .view-btn.active {
    color: var(--primary);
    background: rgba(245, 158, 11, 0.1);
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.15);
  }

  /* Pane headers */
  .pane-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(38, 38, 38, 0.5);
    min-height: 32px;
  }

  .pane-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .pane-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: var(--muted-foreground);
    font-family: var(--font-mono);
  }

  .pane-meta {
    font-size: 10px;
    color: var(--muted-foreground);
    opacity: 0.6;
    font-family: var(--font-mono);
  }

  /* Resize handle */
  .resize-handle {
    width: 5px;
    cursor: col-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--border);
    position: relative;
    transition: background 0.15s ease;
    flex-shrink: 0;
  }

  .resize-handle:hover,
  .resize-handle.dragging {
    background: var(--primary);
  }

  .resize-grip {
    width: 3px;
    height: 24px;
    border-radius: 2px;
    opacity: 0;
    transition: opacity 0.15s ease;
  }

  .resize-handle:hover .resize-grip {
    opacity: 1;
    background: repeating-linear-gradient(
      0deg,
      var(--primary-foreground) 0px,
      var(--primary-foreground) 2px,
      transparent 2px,
      transparent 4px
    );
  }

  /* Status bar */
  .status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    height: 32px;
    border-top: 1px solid var(--border);
    background: rgba(23, 23, 23, 0.8);
    flex-shrink: 0;
  }

  .status-item {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: var(--muted-foreground);
    font-family: var(--font-mono);
    opacity: 0.7;
  }

  /* Save indicator states */
  #status-save {
    transition: color 0.3s ease, opacity 0.3s ease;
  }

  #status-save .save-icon--saving {
    display: none;
  }

  #status-save .save-icon--check {
    display: inline-block;
  }

  #status-save.saving {
    color: var(--primary);
    opacity: 1;
  }

  #status-save.saving .save-icon--saving {
    display: inline-block;
    animation: spin 0.8s linear infinite;
  }

  #status-save.saving .save-icon--check {
    display: none;
  }

  #status-save.saved {
    color: var(--success, #22c55e);
    opacity: 1;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* View modes */
  #editor-root[data-view="editor"] #editor-pane {
    flex: 1;
    min-width: 0;
  }
  #editor-root[data-view="editor"] #preview-pane,
  #editor-root[data-view="editor"] #resize-handle {
    display: none;
  }
  #editor-root[data-view="split"] #editor-pane {
    flex: 1;
    min-width: 0;
  }
  #editor-root[data-view="split"] #preview-pane {
    flex: 1;
    min-width: 0;
  }
  #editor-root[data-view="preview"] #editor-pane,
  #editor-root[data-view="preview"] #resize-handle {
    display: none;
  }
  #editor-root[data-view="preview"] #preview-pane {
    flex: 1;
    min-width: 0;
  }
</style>

<script>
  import { initEditor } from "@/scripts/editor"

  function tryInit() {
    if (document.getElementById("editor-root")) {
      initEditor()
    }
  }

  tryInit()
  document.addEventListener("astro:page-load", tryInit)
</script>
